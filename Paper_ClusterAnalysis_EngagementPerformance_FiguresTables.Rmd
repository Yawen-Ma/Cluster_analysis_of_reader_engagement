---
title: "Cluster analysis reader engagement"
author: "Yawen"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache=TRUE, warning=FALSE, message = FALSE)
```

# Overview 

This code generates the results presented in the paper "Application of cluster analysis to identify different reader groups through their engagement with a digital reading supplement", encompassing all tables, figures, as well as detailed results in the appendices and supplementary materials.

# Table of contents
1.  Load packages needed
2.  Data pre-processing to create the engagement data from log file dataset
3.  Apply five clustering algorithms to the engagement data (including figure 2 - number of clusters; figure 3 - clustering results)
4.  Validation metrics to evaluate algorithms (including Table 1 - validation results)
5.  K-means clustering results (including Figure 4 - Initial literacy ability for each cluster; Figure 5&6 - radar charts; Table S.6 & S.7 for average values of engagement/performance for each cluster)
6. Exploratory data analysis - Figure S.8 & S.9 usage of Clusters 3,4,and 7 across levels of two skills


# Data Structure

*Before the analysis, we perform the hierarchical structure of the dataset below.*

The diagram below provides a brief idea of the structure of the data and levels of variation we might see. 

```{r echo=FALSE}
# install.packages("DiagrammeR")
library(DiagrammeR)
DiagrammeR("graph TB;
           School_district-->School;
           School--> School_year;
           School_year-->Grade;
           Grade-->Placement_Grade;
           Placement_Grade-->Pupil;
           Pupil-->Game;
           Game-->Quest_workflow_y_n;
           Quest_workflow_y_n--> Skill_family;
           Skill_Family --> Game_type;
           Game_type --> Level;
           Level --> Measures;
           Measures --> Duration_round;
           Measures --> Number_of_attempts;
            Measures --> Completed_attempt_n;
           Measures --> Proportion_correct_over_total_answers;
           Measures --> Score;
           Measures --> Level_mastered_y_n")
```


## 1. We first load all the necessary packages here.

```{r include=FALSE}
# if you haven't download any of the package needed, use 'install.packages("[PACKAGES]")' to install first, you can run the code below to install them
# e.g install.packages("dplyr")
#install.packages("dplyr")
#install.packages("tidyverse")
#install.packages("ggplot2")
#install.packages("mclust")
#install.packages("factoextra")
#install.packages("fpc")
#install.packages("fmsb")
#install.packages("knitr")
#install.packages("readr")
#install.packages("extrafont")
```

```{r echo=TRUE}
pkgs <- c('dplyr', 'tidyverse', # data cleaning and data pre-processing, be used to create the engagement data
'ggplot2', # powerful data visualization 
'mclust', # apply the Gaussian graphical models, and examine the BIC (Bayesian Information Criterion) results generated by models
'factoextra', # apply the clustering algorithms, including k-means, k-medoids, clustering large applications, hierarchical clustering, as well as visualization and silhouette coefficients of the clustering results
'fpc', # perform clustering validation metrics including Dunn index and within cluster sum of squares
'extrafont', # into a uniform font e.g. Times New Roman, 12pt, Bold
'readr', # read the dataset
'fmsb'#, # perform radar charts
)
ins <- lapply(pkgs, library, character.only = T) #character.only is for accepting the character of "pkgs"
```

## 2. We create the six engagement variables for each skill.

```{r include=FALSE}
# first read the log file (raw data)
Data_G2 <- read_csv("Data_G2.csv") 

# Variable Dictionary here: (see supplementary materials Table S.1)
# user_id: User id
# skill_family: skill
# round_completed_at: Round ended at
# elapsed_time_m: Elapsed time min
# BOY_performance_level: (initial assessment) DIBELS performance level (4 levels) - 'Well Below Benchmark < Below Benchmark < At Benchmark < Above Benchmark'
# gender_complete: Student gender
# is_esl_complete: Is ell
# is_special_ed_complete: Is special education
# race_complete: Race
```


```{r echo=TRUE}
# 1) all hours spent 
all_hours_spent_on_skills <- Data_G2 %>% 
  filter(!is.na(round_completed_at)) %>% # if a student did not finish the game, the elapsed time on the unfinished rounds is excluded
  mutate(skill = case_when(skill_family == "Early Decoding" ~ "Early_Decoding", 
                           skill_family == "Phonological Awareness" ~ "Phonological_Awareness",
                           skill_family == "Vocabulary" ~ "Vocabulary",
                           skill_family == "Microcomprehension" ~ "Microcomprehension")) %>% # Microcomprehension: comprehension processes
  group_by(user_id, skill) %>%
  filter(skill == "Early_Decoding" | skill == "Phonological_Awareness" | skill == "Vocabulary" | skill == "Microcomprehension") %>%
  group_by(user_id, skill) %>%
  dplyr::summarise(all_hours_spent = sum(elapsed_time_m)/60, # convert mins to hours
            BOY_performance_level, # DIBELS performance level
            gender_complete, 
            is_esl_complete, 
            is_special_ed_complete, 
            race_complete) %>%
  filter(!duplicated(user_id, skill) | n() == 1) %>%
  pivot_wider(., 
              id_cols = c(user_id,
                          BOY_performance_level,
                          gender_complete, 
                          is_esl_complete, 
                          is_special_ed_complete, 
                          race_complete), 
              names_from = skill, 
              names_prefix = "all_hours_spent_on_", 
              values_from = all_hours_spent) 


# 2) variety of games played 
variety_of_games_played_within_skills <- Data_G2 %>% 
  filter(!is.na(round_completed_at)) %>% 
  filter(elapsed_time_m != 0) %>%
  mutate(skill = case_when(skill_family == "Early Decoding" ~ "Early_Decoding",
                           skill_family == "Phonological Awareness" ~ "Phonological_Awareness",
                           skill_family == "Vocabulary" ~ "Vocabulary",
                           skill_family == "Microcomprehension" ~ "Microcomprehension")) %>%
  group_by(user_id, skill) %>%
  filter(skill == "Early_Decoding" | skill == "Phonological_Awareness" | skill == "Vocabulary" | skill == "Microcomprehension") %>%
  dplyr::summarise(variety_of_games = length(unique(game_id))) %>%
  pivot_wider(., 
              id_cols = user_id, 
              names_from = skill, 
              names_prefix = "variety_of_games_played_within_", 
              values_from = variety_of_games)


# 3) all attempts 
all_attempts_within_skills <- Data_G2 %>% 
  filter(!is.na(round_completed_at)) %>% 
  filter(elapsed_time_m != 0) %>%
  mutate(skill = case_when(skill_family == "Early Decoding" ~ "Early_Decoding",
                           skill_family == "Phonological Awareness" ~ "Phonological_Awareness",
                           skill_family == "Vocabulary" ~ "Vocabulary",
                           skill_family == "Microcomprehension" ~ "Microcomprehension")) %>%
arrange(round_started_at) %>%
  group_by(user_id, skill) %>%
  filter(skill == "Early_Decoding" | skill == "Phonological_Awareness" | skill == "Vocabulary" | skill == "Microcomprehension") %>%
  distinct() %>%
  dplyr::summarise(all_attempts = length(game_id)) %>%
  pivot_wider(., 
              id_cols = user_id, 
              names_from = skill, 
              names_prefix = "all_attempts_within_", 
              values_from = all_attempts)


# 4) the number of levels played 
all_number_of_levels_played_within_skills <- Data_G2 %>% 
  filter(!is.na(round_completed_at)) %>% 
  filter(elapsed_time_m != 0) %>%
  mutate(skill = case_when(skill_family == "Early Decoding" ~ "Early_Decoding",
                           skill_family == "Phonological Awareness" ~ "Phonological_Awareness",
                           skill_family == "Vocabulary" ~ "Vocabulary",
                           skill_family == "Microcomprehension" ~ "Microcomprehension",)) %>%
  filter(skill == "Early_Decoding" | skill == "Phonological_Awareness" | skill == "Vocabulary" | skill == "Microcomprehension") %>%
  group_by(user_id, skill, game_id) %>%
  distinct() %>%
  dplyr::summarise(game_id, game_level, levels = length(unique(game_level))) %>%
  dplyr::select(user_id, skill, levels) %>%
  distinct() %>%
  group_by(user_id, skill) %>%
  dplyr::summarise(all_number_of_levels_played = sum(levels)) %>%
  pivot_wider(., 
              id_cols = user_id, 
              names_from = skill, 
              names_prefix = "all_number_of_levels_played_within_", 
              values_from = all_number_of_levels_played)


# 5) days of playing
days_of_playing_within_skills <- Data_G2 %>% 
  filter(elapsed_time_m != 0) %>%
  filter(!is.na(round_completed_at)) %>% 
  mutate(skill = case_when(skill_family == "Early Decoding" ~ "Early_Decoding",
                           skill_family == "Phonological Awareness" ~ "Phonological_Awareness",
                           skill_family == "Vocabulary" ~ "Vocabulary",
                           skill_family == "Microcomprehension" ~ "Microcomprehension",)) %>%
  group_by(user_id, skill) %>%
  filter(skill == "Early_Decoding" | skill == "Phonological_Awareness" | skill == "Vocabulary" | skill == "Microcomprehension") %>%
  distinct() %>%
  dplyr::summarise(day = as_date(round_started_at), days_of_playing_within_skills = length(unique(day))) %>%
  filter(row_number() == 1) %>%
  pivot_wider(., 
              id_cols = user_id, 
              names_from = skill, 
              names_prefix = "days_of_playing_within_", 
              values_from = days_of_playing_within_skills)

# 6) proportion of early exit attempts
proportion_of_early_exit_rounds_within_skills <- Data_G2 %>% 
  filter(elapsed_time_m != 0) %>%
  filter(!is.na(round_completed_at)) %>%
  mutate(skill = case_when(skill_family == "Early Decoding" ~ "Early_Decoding",
                           skill_family == "Phonological Awareness" ~ "Phonological_Awareness",
                           skill_family == "Vocabulary" ~ "Vocabulary",
                           skill_family == "Microcomprehension" ~ "Microcomprehension",)) %>%
  group_by(user_id, skill) %>%
  filter(skill == "Early_Decoding" | skill == "Phonological_Awareness" | skill == "Vocabulary" | skill == "Microcomprehension") %>%
  distinct() %>%
  dplyr::summarise(game_id, game_level, all_number_of_rounds = length(game_id), all_number_of_early_exit_rounds = length(which(is_early_exit == "TRUE")), is_early_exit, proportion_of_early_exit_rounds_within_skills = all_number_of_early_exit_rounds/all_number_of_rounds) %>%
  filter(row_number() == 1) %>%
  pivot_wider(., 
              id_cols = user_id, 
              names_from = skill, 
              names_prefix = "proportion_of_early_exit_rounds_within_", 
              values_from = proportion_of_early_exit_rounds_within_skills)

# integrate the six variables together for each user
user_engagement <- inner_join(all_hours_spent_on_skills, variety_of_games_played_within_skills, by = "user_id")
user_engagement <- inner_join(user_engagement, all_attempts_within_skills, by = "user_id")
user_engagement <- inner_join(user_engagement, all_number_of_levels_played_within_skills, by = "user_id")
user_engagement <- inner_join(user_engagement, days_of_playing_within_skills, by = "user_id")
user_engagement <- inner_join(user_engagement, proportion_of_early_exit_rounds_within_skills, by = "user_id")

# replace NA by 0 for the engagement variables, if the user have no engagement on the skill
user_engagement1 <- user_engagement %>% mutate_at(c(7:ncol(user_engagement)), funs(replace_na(., 0))) 
length(unique(user_engagement1$user_id)) # there are 19,305 users in total, who will be separated into nine groups

write_csv(user_engagement1, "reader_engagement.csv") # this is the engagement data
```

## 3. Apply 5 clustering algorithms to the engagement data.

```{r}
# load the engagement data
user_engagement1 <- read_csv("reader_engagement.csv")
```

### Apply the Gaussian mixture models (GMM) to determine the optimal number of clusters first.
```{r}
# library("mclust") # we use package "mclust" to apply model-based clustering method: GMM
user_engagement2 <- user_engagement1[, 7:30] # we only need engagement data, thus we exclude any information indicating the users themselves (the social demographics; initial literacy ability)
set.seed(123)
df <- scale(user_engagement2) # standardize across the engagement data, involving the conversion each original value into a z-score.
gmm <- Mclust(df) # apply the Gaussian graphical model (GMM) # it takes a few secs 
user_engagement1$cluster_gmm <- gmm$classification # integrate the clustering label from GMM for each user, named "cluster_gmm"

# performing the "figure 2."
m_clust_11 <- Mclust(df, G=1:11) # The BIC for GMM up to 11 clusters
options(scipen=999) # not scientific notation
par(family = "Times New Roman", font=12) # make the font size 12 and times new roman for any texts shown in the figure
# plot(m_clust_11, "BIC", G = 1:11),legendArgs = list(x = "upleft", ncol = 3), xlab = "The number of clusters") # ignore the error for the legend, since we don't need the information of the legend for each model.
plot(m_clust_11, "BIC", G = 1:11, xlab = "The number of clusters")
```

*As shown in the figure, the BIC curve remained relatively flat beyond nine clusters indicating 9 clusters with different levels of engagement as the best solution.*

### Apply the rest 4 clustering algorithms: k-means, k-medoids (PAM), CLARA and hierarchical clustering

```{r}
# library("factoextra") # we use "factoextra" to perform clustering algorithms, including partition clustering methods and hierarchial clustering
set.seed(123)
km_eclust <- eclust(df, "kmeans", 
                    k = 9,  # setting the number of clusters is 9
                    nstart = 50, graph = FALSE)  # apply k-means
user_engagement1$cluster_km_eclust <- km_eclust$cluster # integrate the clustering label from k-means for each user, named "cluster_km_eclust"

set.seed(123)
pam_eclust <- eclust(df, "pam", k = 9, graph = FALSE) # apply k-medoids (partition around medoids (PAM)) # it takes a few secs 
user_engagement1$cluster_pam_eclust <- pam_eclust$cluster # integrate the clustering label from PAM for each user, named "cluster_pam_eclust"

set.seed(123)
clara_eclust <- eclust(df, FUNcluster = "clara", 
                       k = 9, # setting the number of clusters is 9
                       k.max = 10, stand = FALSE, graph = FALSE)  # apply clustering large applications (CLARA)
user_engagement1$cluster_clara_eclust <- clara_eclust$clustering # integrate the clustering label from PAM for each user, named "cluster_clara_eclust"

set.seed(123)
hc_eclust <- eclust(df, "hclust", k = 9, hc_metric = "euclidean",
                 hc_method = "average", graph = FALSE) # apply hierarchical clustering # it takes a few secs 
user_engagement1$cluster_hc_eclust <- hc_eclust$clustering # integrate the clustering label from hierarchical clustering for each user, named "cluster_hc_eclust"
```

### visulization of the clustering results obtained from 5 clustering algorithms

```{r}
# visualize clustering results - each point represents a student
# library(factoextra) # package "factoextra" are used to visualise the clustering results
fviz_mclust(gmm, ggtheme = theme_minimal(), geom = "point", 
            pointsize = 1.2, ellipse = TRUE, ellipse.type = "convex") +
  theme(text=element_text(family="Times New Roman", size=12))

fviz_mclust(km_eclust, ggtheme = theme_minimal(), geom = "point", 
            pointsize = 1.2, ellipse = TRUE, ellipse.type = "convex") +
  theme(text=element_text(family="Times New Roman", size=12))

fviz_mclust(pam_eclust, ggtheme = theme_minimal(), geom = "point", 
            pointsize = 1.2, ellipse = TRUE, ellipse.type = "convex") +
  theme(text=element_text(family="Times New Roman", size=12))

fviz_mclust(clara_eclust,ggtheme = theme_minimal(), geom = "point", 
            pointsize = 1.2, ellipse = TRUE, ellipse.type = "convex") +
  theme(text=element_text(family="Times New Roman", size=12))

fviz_mclust(hc_eclust, ggtheme = theme_minimal(), geom = "point", 
            pointsize = 1.2, ellipse = TRUE, ellipse.type = "convex") +
  theme(text=element_text(family="Times New Roman", size=12))
```

## 4. Cluster validation.

### Table 1. Validation results using 3 internal validation metrics for 5 clustering algorithms

```{r}
## Silhouette coefficient: as higher as better
# Silhouette information can be extracted 
# dunn: as higher as better
# within.cluster.ss: as smaller as better - a cluster that has a small sum of squares is more compact than a cluster that has a large sum of squares.

# library(fpc) # package fpc are used to perform the clustering validation
d <- dist(df)

# Gaussian mixture models (GMM)
cs_gmm = cluster.stats(d, gmm$classification) # it takes a few secs
saveRDS(cs_gmm, file="cs_gmm.RData")
cs_gmm <- readRDS("cs_gmm.RData")
cs_gmm[c("within.cluster.ss","avg.silwidth", "dunn")] # silhouette: -0.0265033 # wcss: 262873.5 # dunn: 0.0006293064

# k-means
cs_km = cluster.stats(d, km_eclust$cluster) # it takes a few secs
saveRDS(cs_km, file="cs_km.RData")
cs_km <- readRDS("cs_km.RData")
cs_km[c("within.cluster.ss","avg.silwidth", "dunn")] # silhouette: 0.165256 # wcss: 181402.3 # dunn: 0.001127537
# OR a easier/quicker to obtain the silhouette coefficient is "km_eclust$silinfo$avg.width".

# pam
cs_pam = cluster.stats(d, pam_eclust$cluster)
saveRDS(cs_pam, file="cs_pam.RData")
cs_pam <- readRDS("cs_pam.RData")
cs_pam[c("within.cluster.ss","avg.silwidth", "dunn")] # silhouette: 0.1300961 # wcss: 194398.9 # dunn: 0.001865158
# OR a easier/quicker to obtain the silhouette coefficient is "pam_eclust$silinfo$avg.width".

# clara
cs_clara = cluster.stats(d, clara_eclust$cluster)
saveRDS(cs_clara, file="cs_clara.RData")
cs_clara <- readRDS("cs_clara.RData")
cs_clara[c("within.cluster.ss","avg.silwidth", "dunn")] # silhouette: 0.1132297 # wcss: 202077.8 # dunn: 0.001141634
# OR a easier/quicker to obtain the silhouette coefficient is "clara.res$silinfo$avg.width". # 0.1710795


# hc
cs_hc = cluster.stats(d, hc_eclust$cluster)
saveRDS(cs_hc, file="cs_hc.RData")
cs_hc <- readRDS("cs_hc.RData")
cs_hc[c("within.cluster.ss","avg.silwidth", "dunn")] # silhouette: 0.6747994 # wcss:443703.3 the smaller the more compact # dunn: 0.2131273
# OR a easier/quicker to obtain the silhouette coefficient is "hc_eclust$silinfo$avg.width". # 0.6747994
```

### Table S.3 (see supplementary materials) - The average silhouette width for each cohort for each method 

```{r}
## plots and values for silhouette width for each group
fviz_silhouette(km_eclust, palette = "jco", ggtheme = theme_classic())
fviz_silhouette(pam_eclust, palette = "jco", ggtheme = theme_classic())
fviz_silhouette(clara_eclust, palette = "jco", ggtheme = theme_classic())
fviz_silhouette(hc_eclust, palette = "jco", ggtheme = theme_classic())

#library(cluster) # using cluster package to conduct the silhouette coefficient width for each cohort for Gaussian mixture models (GMM)
#sil<-silhouette(gmm$classification,na.omit(df))
#fviz_silhouette(sil,label=FALSE,print.summary=FALSE)
```

*K-means performed the best out of the five we tested, thus the results from k-means was used for the remaider of our analysis. *

## 5. Clustering results (k-means).

### 5.1 Figure 4 - Initial literacy ability (DIBELS) of each cluster. 

```{r}
# library(extrafont) # into a uniform font e.g. Times New Roman, 12pt, Bold

# change clustering labels
user_engagement1 <- user_engagement1 %>% mutate(cluster_km_eclust_reorder = case_when(cluster_km_eclust == 1 ~ 1,
                                                                                         cluster_km_eclust == 2 ~ 4,
                                 cluster_km_eclust == 3 ~ 5,
                                 cluster_km_eclust == 4 ~ 2,
                                 cluster_km_eclust == 5 ~ 8,
                                 cluster_km_eclust == 6 ~ 3,
                                 cluster_km_eclust == 7 ~ 9,
                                 cluster_km_eclust == 8 ~ 6,
                                 cluster_km_eclust == 9 ~ 7))
user_engagement1 %>% group_by(cluster_km_eclust_reorder) %>% dplyr::summarise(n = length(unique(user_id))) 

dibels_graph <- user_engagement1 %>% 
  group_by(cluster_km_eclust_reorder) %>%
  dplyr::reframe(totol = length(user_id), BOY_performance_level) %>%
  ungroup(.) %>%
  group_by(cluster_km_eclust_reorder, BOY_performance_level) %>%
  dplyr::mutate(n = length(BOY_performance_level), p = round(n/totol * 100, digits = 2)) %>%
  distinct(.) %>%
  ggplot(., aes(x = as.factor(cluster_km_eclust_reorder), y = p, group = BOY_performance_level)) + geom_bar(aes(fill = BOY_performance_level), stat = "identity") +
  geom_text(aes(label = p), position = position_stack(vjust = 0.5), size = 3, family = "Times New Roman") + 
  xlab("Clusters") + ylab("Proportion of users (%)") + 
  theme_bw() + theme(panel.grid=element_blank()) +  guides(fill = guide_legend(title = "Beginning-of-Year performance")) + theme(text=element_text(family="Times New Roman", face = "bold", size=12)) + geom_hline(yintercept = c(50,75), linetype = "dashed")
dibels_graph
```

### 5.2 Average value of 6 engagement variables (Table S.6 - clustering results of the engagement values for each cluster across four skills). 

```{r}
library(knitr) # to generate table in Rmarkdown
# all hours spent
user_engagement1 %>% group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_allhours_ED = mean(all_hours_spent_on_Early_Decoding),
                   mean_allhours_PA = mean(all_hours_spent_on_Phonological_Awareness),
                   mean_allhours_V = mean(all_hours_spent_on_Vocabulary),
                   mean_allhours_MC = mean(all_hours_spent_on_Microcomprehension),
                   n = length(unique(user_id))) %>%
  kable(.)

# variety of games
user_engagement1 %>% group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_varietygame_ED = mean(variety_of_games_played_within_Early_Decoding),
                   mean_varietygame_PA = mean(variety_of_games_played_within_Phonological_Awareness),
                   mean_varietygame_V = mean(variety_of_games_played_within_Vocabulary),
                   mean_varietygame_MC = mean(variety_of_games_played_within_Microcomprehension),
                   n = length(unique(user_id))) %>%
  kable(.)

# all attempts 
user_engagement1 %>% group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_allattempts_ED = mean(all_attempts_within_Early_Decoding),
                   mean_allattempts_PA = mean(all_attempts_within_Phonological_Awareness),
                   mean_allattempts_V = mean(all_attempts_within_Vocabulary),
                   mean_allattempts_MC = mean(all_attempts_within_Microcomprehension),
                   n = length(unique(user_id))) %>%
  kable(.)

# number of levels played
user_engagement1 %>% group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_nlp_ED = mean(all_number_of_levels_played_within_Early_Decoding),
                   mean_nlp_PA = mean(all_number_of_levels_played_within_Phonological_Awareness),
                   mean_nlp_V = mean(all_number_of_levels_played_within_Vocabulary),
                   mean_nlp_MC = mean(all_number_of_levels_played_within_Microcomprehension),
                   n = length(unique(user_id))) %>%
  kable(.)

# days of playing
user_engagement1 %>% group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_days_ED = mean(days_of_playing_within_Early_Decoding),
                   mean_days_PA = mean(days_of_playing_within_Phonological_Awareness),
                   mean_days_V = mean(days_of_playing_within_Vocabulary),
                   mean_days_MC = mean(days_of_playing_within_Microcomprehension),
                   n = length(unique(user_id))) %>%
  kable(.)

# proportion of early exit rounds
user_engagement1 %>% group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_peer_ED = mean(proportion_of_early_exit_rounds_within_Early_Decoding),
                   mean_peer_PA = mean(proportion_of_early_exit_rounds_within_Phonological_Awareness),
                   mean_peer_V = mean(proportion_of_early_exit_rounds_within_Vocabulary),
                   mean_peer_MC = mean(proportion_of_early_exit_rounds_within_Microcomprehension),
                   n = length(unique(user_id))) %>%
  kable(.)
```

### 5.3 Average value of 4 performance variables (Table S.7 - clustering results of the performance values for each cluster across four skills). 
#### 1). Number of levels mastered

```{r}
# read the log file for Grade 2 students
Data_G2 <- read_csv("Data_G2.csv")
# Number of levels mastered
all_number_of_levels_mastered_within_skills <- Data_G2 %>% 
  filter(!is.na(round_completed_at)) %>% 
  filter(elapsed_time_m != 0) %>%
  filter(is_early_exit == "FALSE") %>%
  filter(is_level_mastered == TRUE) %>% 
  mutate(skill = case_when(skill_family == "Early Decoding" ~ "Early_Decoding",
                           skill_family == "Phonological Awareness" ~ "Phonological_Awareness",
                           skill_family == "Vocabulary" ~ "Vocabulary",
                           skill_family == "Microcomprehension" ~ "Microcomprehension")) %>%
  group_by(user_id, skill, game_id) %>%
  filter(skill == "Early_Decoding" | skill == "Phonological_Awareness" | skill == "Vocabulary" | skill == "Microcomprehension") %>%
  distinct() %>%
  dplyr::summarise(all_number_of_levels_mastered_within_games = length(unique(game_level))) %>%
  group_by(user_id, skill) %>%
  dplyr::summarise(all_number_of_levels_mastered = sum(all_number_of_levels_mastered_within_games)) %>%
  pivot_wider(., 
              id_cols = user_id, 
              names_from = skill, 
              names_prefix = "all_number_of_levels_mastered_within_", 
              values_from = all_number_of_levels_mastered)
#18824 users has mastered at least one level within 4 skill families
# 18721 users
summary(all_number_of_levels_mastered_within_skills)

user_id <- unique(user_engagement1$user_id)
user_id <- as.data.frame(user_id)
all_number_of_levels_mastered_within_skills <- left_join(user_id, all_number_of_levels_mastered_within_skills, by = "user_id")

all_number_of_levels_mastered_within_skills$all_number_of_levels_mastered_within_Phonological_Awareness[is.na(all_number_of_levels_mastered_within_skills$all_number_of_levels_mastered_within_Phonological_Awareness)] <- 0
all_number_of_levels_mastered_within_skills$all_number_of_levels_mastered_within_Early_Decoding[is.na(all_number_of_levels_mastered_within_skills$all_number_of_levels_mastered_within_Early_Decoding)] <- 0
all_number_of_levels_mastered_within_skills$all_number_of_levels_mastered_within_Vocabulary[is.na(all_number_of_levels_mastered_within_skills$all_number_of_levels_mastered_within_Vocabulary)] <- 0
all_number_of_levels_mastered_within_skills$all_number_of_levels_mastered_within_Microcomprehension[is.na(all_number_of_levels_mastered_within_skills$all_number_of_levels_mastered_within_Microcomprehension)] <- 0

left_join(user_engagement1, all_number_of_levels_mastered_within_skills, by = "user_id") %>% 
  group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_nlm_PA = mean(all_number_of_levels_mastered_within_Phonological_Awareness),
                   mean_nlm_ED = mean(all_number_of_levels_mastered_within_Early_Decoding),
                   mean_nlm_V = mean(all_number_of_levels_mastered_within_Vocabulary),
                   mean_nlm_MC = mean(all_number_of_levels_mastered_within_Microcomprehension),
                   n = length(user_id)) %>%
  kable(.)
```

#### 2). Time to mastery

```{r}
# user_id_master is the user_id for user_engagement1
user_id_master <- unique(all_number_of_levels_mastered_within_skills$user_id)

help <- Data_G2 %>% # 
  filter(user_id %in% user_id_master) %>%
  filter(skill_family == "Early Decoding"| skill_family == "Phonological Awareness" | skill_family == "Vocabulary" | skill_family == "Microcomprehension") %>%
  filter(is_early_exit == "FALSE") %>%
  arrange(round_started_at) %>%
  group_by(user_id, skill_family, game_id, game_level) %>%
  dplyr::summarise(is_level_mastered, elapsed_time_m, round_started_at)

help1 <- help  %>%
  group_by(user_id, skill_family, game_id, game_level, is_level_mastered) %>% 
  dplyr::summarise(n = length(is_level_mastered)) %>%
  pivot_wider(., 
              id_cols = c(user_id, skill_family, game_id, game_level),
              names_from = is_level_mastered,
              values_from = n,
              names_prefix = "n_")
help1
ttm_separate <- help %>% 
  pivot_wider(., 
              id_cols = c(user_id, skill_family, game_id, game_level),
              names_from = is_level_mastered,
              values_from = elapsed_time_m,
              names_prefix = "is_level_mastered_",
              values_fn = sum)
ttm_not_correct <- left_join(ttm_separate, help1) %>% dplyr::select(user_id, skill_family, game_id, game_level, is_level_mastered_FALSE, is_level_mastered_TRUE, n_FALSE, n_TRUE)
ttm_correct <- ttm_not_correct %>% mutate(is_level_mastered_TRUE_correct_average = is_level_mastered_TRUE / n_TRUE) %>% dplyr::select(user_id, skill_family, game_id, game_level, is_level_mastered_FALSE, is_level_mastered_TRUE_correct_average, n_FALSE, n_TRUE)
ttm_correct$is_level_mastered_FALSE[is.na(ttm_correct$is_level_mastered_FALSE)] <- 0
ttm_correct$is_level_mastered_TRUE_correct_average[is.na(ttm_correct$is_level_mastered_TRUE_correct_average)] <- 0
ttm_game <- ttm_correct %>% mutate(ttm_game_id = is_level_mastered_FALSE + is_level_mastered_TRUE_correct_average)
ttm_game

write_csv(ttm_game, "ttm_skill_game_level_user.csv") # will be used later when we generate the exploratory data analysis for Figures 8 & 9 - The number of individuals from Cluster 3, 4, and 7 who played each level of the early decoding/vocabulary games.

 ttm_skill_mean <- 
  ttm_game %>% ungroup() %>%
  group_by(user_id, skill_family) %>%
  dplyr::summarise(ttm = mean(ttm_game_id))
ttm_skill_mean

# pivot_wider
ttm_skill <- ttm_skill_mean %>% 
  pivot_wider(., 
              id_cols = user_id, 
              names_from = skill_family, 
              names_prefix = "ttm_within_", 
              values_from = ttm)
summary(ttm_skill)

# bind the ttm for each user with the cluster label

left_join(user_engagement1,ttm_skill, by = "user_id") %>% 
  group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_ttm_PA = mean(`ttm_within_Phonological Awareness`, na.rm = TRUE),
    mean_ttm_ED = mean(`ttm_within_Early Decoding`, na.rm = TRUE),
                   
                   mean_ttm_V = mean(`ttm_within_Vocabulary`, na.rm = TRUE),
                   mean_ttm_MC = mean(`ttm_within_Microcomprehension`, na.rm = TRUE),
                   n = length(user_id)) %>%
  kable(.)
```

#### 3). Attempts to mastery 

```{r}
all_attempts_within_skills <- Data_G2 %>% 
  filter(!is.na(round_completed_at)) %>% 
  filter(elapsed_time_m != 0) %>%
  filter(is_level_mastered == TRUE) %>% 
  mutate(skill = case_when(skill_family == "Early Decoding" ~ "Early_Decoding",
                           skill_family == "Phonological Awareness" ~ "Phonological_Awareness",
                            skill_family == "Vocabulary" ~ "Vocabulary",
                           skill_family == "Microcomprehension" ~ "Microcomprehension")) %>%
  group_by(user_id, skill, game_id) %>%
  filter(skill == "Early_Decoding" | skill == "Phonological_Awareness" | skill == "Vocabulary" | skill == "Microcomprehension") %>%
  distinct() %>%
  dplyr::summarise(all_number_of_levels_mastered_within_games = length(unique(game_level))) %>%
  group_by(user_id, skill) %>%
  dplyr::summarise(all_number_of_levels_mastered = sum(all_number_of_levels_mastered_within_games)) %>%
  pivot_wider(., 
              id_cols = user_id, 
              names_from = skill, 
              names_prefix = "all_number_of_levels_mastered_within_", 
              values_from = all_number_of_levels_mastered)

ttm_game$n_FALSE_0 <- ttm_game$n_FALSE
ttm_game$n_FALSE_0[is.na(ttm_game$n_FALSE)] <- 0
ttm_game$attempts_to_mastery <- ttm_game$n_FALSE_0 + 1
attempts_to_mastered_within_skills <- 
  ttm_game %>% ungroup() %>%
  group_by(user_id, skill_family) %>%
  dplyr::summarise(attempts_to_mastery = mean(attempts_to_mastery)) %>%
  mutate(skill = case_when(skill_family == "Early Decoding" ~ "Early_Decoding",
                           skill_family == "Phonological Awareness" ~ "Phonological_Awareness",
                           skill_family == "Vocabulary" ~ "Vocabulary",
                           skill_family == "Microcomprehension" ~ "Microcomprehension")) %>%
  pivot_wider(., 
              id_cols = user_id,
              names_from = skill,
              names_prefix = "attempts_to_mastered_within_",
              values_from = attempts_to_mastery) 
summary(attempts_to_mastered_within_skills)

# bind atm with cluster label

left_join(user_engagement1,attempts_to_mastered_within_skills, by = "user_id") %>% 
  group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_atm_PA = mean(attempts_to_mastered_within_Phonological_Awareness, na.rm = TRUE),
    mean_atm_ED = mean(attempts_to_mastered_within_Early_Decoding, na.rm = TRUE),
                   
                   mean_atm_V = mean(attempts_to_mastered_within_Vocabulary, na.rm = TRUE),
                   mean_atm_MC = mean(attempts_to_mastered_within_Microcomprehension, na.rm = TRUE),
                   n = length(user_id)) %>%
  kable(.)
```

#### 4). Speed of mastery

```{r}
spm <- left_join(user_engagement1, all_number_of_levels_mastered_within_skills, by = "user_id") %>%
  dplyr::group_by(user_id) %>%
  dplyr::summarise(spm_PA = 
                     all_number_of_levels_mastered_within_Phonological_Awareness/all_hours_spent_on_Phonological_Awareness,
                   spm_ED = 
      all_number_of_levels_mastered_within_Early_Decoding/all_hours_spent_on_Early_Decoding,
                   spm_V = all_number_of_levels_mastered_within_Vocabulary/all_hours_spent_on_Vocabulary,
                   spm_MC = all_number_of_levels_mastered_within_Microcomprehension/all_hours_spent_on_Microcomprehension)
# calculate those who didn't master any level within one skill
summary(spm)
spm$spm_ED[is.nan(spm$spm_ED)] <- 0
spm$spm_PA[is.nan(spm$spm_PA)] <- 0
spm$spm_V[is.nan(spm$spm_V)] <- 0
spm$spm_MC[is.nan(spm$spm_MC)] <- 0

# bind spm with cluster label

left_join(user_engagement1,spm, by = "user_id") %>% 
  group_by(cluster_km_eclust_reorder) %>%
  dplyr::summarise(mean_stm_PA = mean(spm_PA),
    mean_stm_ED = mean(spm_ED),
                   
                   mean_stm_V = mean(spm_V),
                   mean_stm_MC = mean(spm_MC),
                   n = length(user_id)) %>%
  kable(.)
```



### 5.4 Figure 5: Radar charts for phonological awareness and early decoding.

```{r}
# library(fmsb) # we use "fmsb" package to perform radar chart

# based on the ranking results for each variable for each cluster, we use the radar chart to show the informative engagement information

C1 <- as.data.frame(matrix(c(7,7, 3,2, 3,2, 7,7, 2,2), ncol = 5)) # the numbers filled in are the ranking results for each dimension, counterclockwise
colnames(C1) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C1) <- c("Phonological Awareness", "Early Decoding")
C_1 <- rbind(rep(9, 5), rep(1, 5), C1)
colors_in <- c("#64B8FF", "#00008B")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12)
radarchart(C_1, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C1),
           pcol = colors_in,
           title = "Cluster 1 (n = 1726, 8.94%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5#size of value labels
           )


C2 <- as.data.frame(matrix(c(4,5, 1,1, 1,1, 4,4, 1,1), ncol = 5))
colnames(C2) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C2) <- c("PA", "ED")
C_2 <- rbind(rep(9, 5), rep(1, 5), C2)
colors_in <- c("#64B8FF", "#00008B")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12)
radarchart(C_2, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C1),
           pcol = colors_in,
            title = "Cluster 2 (n = 571, 2.96%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C3 <- as.data.frame(matrix(c(8,6, 4,3, 6,3, 8,6, 4,3), ncol = 5))
colnames(C3) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C3) <- c("PA", "ED")
C_3 <- rbind(rep(9, 5), rep(1, 5), C3)
colors_in <- c("#64B8FF", "#00008B")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12)
radarchart(C_3, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C1),
           pcol = colors_in,
           title = "Cluster 3 (n = 3468, 17.96%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C4 <- as.data.frame(matrix(c(9,9, 5,4, 4,4, 9,9, 6,4), ncol = 5))
colnames(C4) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C4) <- c("PA", "ED")
C_4 <- rbind(rep(9, 5), rep(1, 5), C4)
colors_in <- c("#64B8FF", "#00008B")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12)
radarchart(C_4, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C1),
           pcol = colors_in,
           title = "Cluster 4 (n = 4862, 25.19%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C5 <- as.data.frame(matrix(c(2,1, 2,6, 2,6, 1,1, 3,6), ncol = 5))
colnames(C5) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C5) <- c("PA", "ED")
C_5 <- rbind(rep(9, 5), rep(1, 5), C5)
colors_in <- c("#64B8FF", "#00008B")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12)
radarchart(C_5, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C1),
           pcol = colors_in,
          title = "Cluster 5 (n = 248, 1.28%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C6 <- as.data.frame(matrix(c(6,3, 6,5, 8,5, 5,2, 5,5), ncol = 5))
colnames(C6) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C6) <- c("PA", "ED")
C_6 <- rbind(rep(9, 5), rep(1, 5), C6)
colors_in <- c("#64B8FF", "#00008B")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12)
radarchart(C_6, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C1),
           pcol = colors_in,
          title = "Cluster 6 (n = 1126, 5.83%)",  
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C7 <- as.data.frame(matrix(c(5,8, 7,7, 5,8, 6,8, 7,7), ncol = 5))
colnames(C7) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C7) <- c("PA", "ED")
C_7 <- rbind(rep(9, 5), rep(1, 5), C7)
colors_in <- c("#64B8FF", "#00008B")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12)
radarchart(C_7, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C1),
           pcol = colors_in,
         title = "Cluster 7 (n = 4001, 20.73%)",  
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C8 <- as.data.frame(matrix(c(3,4, 8,8, 7,7, 3,5, 8,8), ncol = 5))
colnames(C8) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C8) <- c("PA", "ED")
C_8 <- rbind(rep(9, 5), rep(1, 5), C8)
colors_in <- c("#64B8FF", "#00008B")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12)
radarchart(C_8, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C1),
           pcol = colors_in,
          title = "Cluster 8 (n = 2516, 13.03%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C9 <- as.data.frame(matrix(c(1,2, 9,9, 9,9, 2,3, 9,9), ncol = 5))
colnames(C9) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C9) <- c("Phonological Awareness", "Early Decoding")
C_9 <- rbind(rep(9, 5), rep(1, 5), C9)
colors_in <- c("#64B8FF", "#00008B")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12)
radarchart(C_9, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C1),
           pcol = colors_in,
         title = "Cluster 9 (n = 787, 4.08%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)
```

### 5.5 Figure 6: Radar charts for vocabulary and comprehension processes 

```{r}
# V,MC
C1 <- as.data.frame(matrix(c(3,3, 5,5, 3,4, 3,3, 3,1), ncol = 5))
colnames(C1) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C1) <- c("V", "MC")
C_1 <- rbind(rep(9, 5), rep(1, 5), C1)
colors_in <- c("#FFA500","#FF0000")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12, face = "bold")
radarchart(C_1, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C_9),
           pcol = colors_in,
         title = "Cluster 1 (n = 1726, 8.94%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C2 <- as.data.frame(matrix(c(1,1, 7,6, 6,6, 1,1, 4,5), ncol = 5))
colnames(C2) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C2) <- c("V", "MC")
C_2 <- rbind(rep(9, 5), rep(1, 5), C2)
colors_in <- c("#FFA500","#FF0000")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12, face = "bold")
radarchart(C_2, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C_9),
           pcol = colors_in,
         title = "Cluster 2 (n = 571, 2.96%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C3 <- as.data.frame(matrix(c(6,6, 3,4, 3,4, 5,6, 2,4), ncol = 5))
colnames(C3) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C3) <- c("V", "MC")
C_3 <- rbind(rep(9, 5), rep(1, 5), C3)
colors_in <- c("#FFA500","#FF0000")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12, face = "bold")
radarchart(C_3, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C_9),
           pcol = colors_in,
         title = "Cluster 3 (n = 3468, 17.96%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C4 <- as.data.frame(matrix(c(8,9, 1,2, 4,8, 8,9, 1,3), ncol = 5))
colnames(C4) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C4) <- c("V", "MC")
C_4 <- rbind(rep(9, 5), rep(1, 5), C4)
colors_in <- c("#FFA500","#FF0000")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12, face = "bold")
radarchart(C_4, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C_9),
           pcol = colors_in,
           title = "Cluster 4 (n = 4862, 25.19%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C5 <- as.data.frame(matrix(c(2,2, 8,9, 8,9, 2,2, 8,8), ncol = 5))
colnames(C5) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C5) <- c("V", "MC")
C_5 <- rbind(rep(9, 5), rep(1, 5), C5)
colors_in <- c("#FFA500","#FF0000")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12, face = "bold")
radarchart(C_5, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C_9),
           pcol = colors_in,
           title = "Cluster 5 (n = 248, 1.28%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C6 <- as.data.frame(matrix(c(4,4, 6,7, 2,5, 4,4, 7,7), ncol = 5))
colnames(C6) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C6) <- c("V", "MC")
C_6 <- rbind(rep(9, 5), rep(1, 5), C6)
colors_in <- c("#FFA500","#FF0000")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12, face = "bold")
radarchart(C_6, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C_9),
           pcol = colors_in,
           title = "Cluster 6 (n = 1126, 5.83%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C7 <- as.data.frame(matrix(c(9,8, 2,1, 9,2, 9,8, 5,2), ncol = 5))
colnames(C7) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C7) <- c("V", "MC")
C_7 <- rbind(rep(9, 5), rep(1, 5), C7)
colors_in <- c("#FFA500","#FF0000")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12, face = "bold")
radarchart(C_7, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C_9),
           pcol = colors_in,
           title = "Cluster 7 (n = 4001, 20.73%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C8 <- as.data.frame(matrix(c(7,7, 4,3, 5,1, 7,7, 6,6), ncol = 5))
colnames(C8) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C8) <- c("V", "MC")
C_8 <- rbind(rep(9, 5), rep(1, 5), C8)
colors_in <- c("#FFA500","#FF0000")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12, face = "bold")
radarchart(C_8, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C_9),
           pcol = colors_in,
           title = "Cluster 8 (n = 2516, 13.03%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)

C9 <- as.data.frame(matrix(c(5,5, 9,8, 7,7, 6,5, 9,9), ncol = 5))
colnames(C9) <- c("engagement", "time", "speed", "levels", "attempts")
rownames(C9) <- c( "V", "MC")
C_9 <- rbind(rep(9, 5), rep(1, 5), C9)
colors_in <- c("#FFA500","#FF0000")
par(mar = c(1, 2, 2, 1), family = "Times New Roman", font=12, face = "bold")
radarchart(C_9, 
           caxislabels = c(1,2,3,4,5,6,7,8,9),
           seg = 8,
           axistype = 3,
           axislabcol = "grey", 
           vlabels = colnames(C_9),
           pcol = colors_in,
           title = "Cluster 9 (n = 787, 4.08%)", 
           cex.main = 2,
           plwd = 4,
           plty = 1,
           vlcex = 2,
           palcex = 1.5
)
```


## 6. Exploratory Data Analysis - figure S.8 and S.9 (see supplementary materials)
ttm changes refer to levels - graphic way

```{r}
ttm_game <- read_csv("ttm_skill_game_level_user.csv") # directly use the dataset obtained when we calculating time to mastery 
ttm_label <- left_join(ttm_game, user_engagement1[, c("user_id", "cluster_km_eclust_reorder")], by = "user_id") 
ttm_label$cluster_km_eclust_reorder <- as.character(ttm_label$cluster_km_eclust_reorder)
ttm_label$game_level <- as.factor(ttm_label$game_level)

PA <- ttm_label %>% filter(skill_family == "Phonological Awareness")
ED <- ttm_label %>% filter(skill_family == "Early Decoding") 
V <- ttm_label %>% filter(skill_family == "Vocabulary")
MC <- ttm_label %>% filter(skill_family == "Microcomprehension") # comprehension processes

ED %>%
  mutate(level = as.numeric(game_level)) %>%
  filter(cluster_km_eclust_reorder == 3 | 
           cluster_km_eclust_reorder == 4 |
           cluster_km_eclust_reorder == 7) %>%
  group_by(level, cluster_km_eclust_reorder) %>%
  dplyr::summarise(number_of_users = length(unique(user_id)) ) %>%
  ggplot(.) + geom_bar(aes(x = level, y = number_of_users), stat = "identity") + facet_wrap(~ cluster_km_eclust_reorder) + scale_x_continuous(breaks = seq(0, 200, 20)) + theme_light() + xlab("Game level") + ylab("Number of users")+
  theme(text=element_text(family="Times New Roman", size=12))

V %>%
  mutate(level = as.numeric(game_level)) %>%
  filter(cluster_km_eclust_reorder == 3 | 
           cluster_km_eclust_reorder == 4 |
           cluster_km_eclust_reorder == 7) %>%
  group_by(level, cluster_km_eclust_reorder) %>%
  dplyr::summarise(number_of_users = length(unique(user_id)) ) %>%
  ggplot(.) + geom_bar(aes(x = level, y = number_of_users), stat = "identity") + facet_wrap(~ cluster_km_eclust_reorder) + scale_x_continuous(breaks = seq(0, 50, 10)) + theme_light() + xlab("Game level") + ylab("Number of users")+
  theme(text=element_text(family="Times New Roman", size=12))
```

